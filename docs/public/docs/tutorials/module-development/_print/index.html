<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.119.0"><link rel=canonical type=text/html href=/docs/tutorials/module-development/><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>模块研发 | Koupleless</title><meta name=description content="Koupleless 模块研发"><meta property="og:title" content="模块研发"><meta property="og:description" content="Koupleless 模块研发"><meta property="og:type" content="website"><meta property="og:url" content="/docs/tutorials/module-development/"><meta itemprop=name content="模块研发"><meta itemprop=description content="Koupleless 模块研发"><meta name=twitter:card content="summary"><meta name=twitter:title content="模块研发"><meta name=twitter:description content="Koupleless 模块研发"><link rel=preload href=/scss/main.min.dd7b72f9267db0e97a69cb30707c5fc5882975a4ea1f005b8e16e8f65c5ea9b1.css as=style><link href=/scss/main.min.dd7b72f9267db0e97a69cb30707c5fc5882975a4ea1f005b8e16e8f65c5ea9b1.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script>
<link rel=stylesheet href=/css/prism.css><meta name=google-site-verification content="iznGJXncH7YgD6J5kSrqbWh9GoPi5Zfzu1qJ9iDuID8"><link href=/img/logo.svg rel=icon type=image/svg><link href=/search/pagefind-ui.css rel=stylesheet><script src=/search/pagefind-ui.js type=text/javascript></script>
<script>window.addEventListener("DOMContentLoaded",e=>{new PagefindUI({element:".td-search"})})</script><script src=https://o.alicdn.com/mecloud/shell/dialog.js></script>
<script>window.AlimeDialog({from:"i1OVpVbH98"})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-DZ8Q3F0GZ7","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DZ8Q3F0GZ7"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DZ8Q3F0GZ7")}</script></head><body class=td-section><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg width="26" height="29" viewBox="0 0 26 29" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient x1="52.6662558%" y1="95.7312514%" x2="35.7492678%" y2="11.0078657%" id="linearGradient-wxw43fh1xd-1"><stop stop-color="#9822e4" offset="0"/><stop stop-color="#e643fa" offset="86.0585504%"/><stop stop-color="#f876ff" offset="100%"/></linearGradient><path d="M15.9275871 1.54432572 15.936122 1.5594269 15.9445709 1.57457632 5.01248933 7.79418913 7.699 9.304l8.8412359-4.72420311.8668497-.49490764C17.4171462 4.0791454 17.4272394 4.07345885 17.4373647 4.06782987c1.474137-.81952243 3.3335154-.28885241 4.1530379 1.18528466L10.875 11.088l2.864 1.609 8.843271-5.6213813c1.1038914-.6292563 2.5021428-.23250173 3.1230817.88617614C25.8984381 8.30965565 25.9998668 8.70204694 25.9998668 9.10116416V19.9436637c0 1.3476373-1.002317 2.484932-2.3392704 2.6542897L22.9421516 22.6889619V10.4257286L20.457252 12.0257475 20.457758 23.6880152c0 1.2665471-1.0267393 2.2932864-2.2932864 2.2932864H17.59115L17.590252 13.8727475 15.106 15.473 15.1067564 27.0588825c0 1.0695936-.855616100000001 1.9366704-1.911072 1.9366704C12.8696714 28.9955529 12.5490782 28.9110348 12.2643947 28.7500365L1.63270516 23.3171586C.159863707 22.5645249-.423980046 20.7604209.328653641 19.2875794L.372104915 19.2057013 12.0490412 25.0797183 12.049 22.086 1.98952173 16.7675786C.51279311 15.9867912-.0513787599 14.1567129.729408593 12.6799843L.744416289 12.6519572.759717752 12.6240895 12.049 18.593 12.0490412 15.2566254 1.7391964 9.45898637C1.44132502 9.2850324 1.19527431 9.0328708 1.02697438 8.72907568c-.516688418-.93266477-.189466545-2.11320819.7308705-2.63681754C6.19445786 3.56812633 9.52191759 1.67502747 11.7402241.412961569L11.7628911.400065593c1.4660277-.834070345 3.3306257-.321767634 4.164696 1.144260127z" id="path-wxw43fh1xd-2"/><linearGradient x1="50.6099966%" y1="31.6743333%" x2="50.2419846%" y2="73.0702907%" id="linearGradient-wxw43fh1xd-4"><stop stop-color="#8200b5" offset="0"/><stop stop-color="#8200b5" stop-opacity="0" offset="100%"/></linearGradient><linearGradient x1="50.6028666%" y1="31.6743333%" x2="50.2391561%" y2="73.0702907%" id="linearGradient-wxw43fh1xd-5"><stop stop-color="#8200b5" offset="0"/><stop stop-color="#8200b5" stop-opacity="0" offset="100%"/></linearGradient><linearGradient x1="90.8235257%" y1="50%" x2="3.24041867%" y2="52.9415572%" id="linearGradient-wxw43fh1xd-6"><stop stop-color="#dd3ff7" stop-opacity="0" offset="0"/><stop stop-color="#ca23e4" offset="100%"/></linearGradient><linearGradient x1="74.3272776%" y1="35.8586031%" x2="19.6895996%" y2="19.3309621%" id="linearGradient-wxw43fh1xd-7"><stop stop-color="#b800d1" stop-opacity="0" offset="0"/><stop stop-color="#ae00c5" offset="100%"/></linearGradient><linearGradient x1="97.0070676%" y1="71.8003287%" x2="11.3661868%" y2="30.5044309%" id="linearGradient-wxw43fh1xd-8"><stop stop-color="#940ec7" offset="0"/><stop stop-color="#c435f0" stop-opacity="0" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页" transform="translate(-24.000000, -18.000000)"><g id="编组-4" transform="translate(24.000133, 16.000000)"><g id="路径-6-copy-2" transform="translate(0.000000, 2.004447)"><mask id="mask-wxw43fh1xd-3" fill="#fff"><use xlink:href="#path-wxw43fh1xd-2"/></mask><use id="Mask" fill="url(#linearGradient-wxw43fh1xd-1)" fill-rule="nonzero" xlink:href="#path-wxw43fh1xd-2"/><path d="M12.0490412 15.2684078 13.03943 15.5167092C14.3279076 16.0478608 15.1686754 17.3038563 15.1686754 18.6975193V18.7421449v9.047164l-3.1196342-1.4070083V15.2684078z" id="Path-114-Copy-2" fill="url(#linearGradient-wxw43fh1xd-4)" opacity=".69047619" mask="url(#mask-wxw43fh1xd-3)"/><path d="M22.9421516 10.4227424 23.8594661 10.2542707C24.8889759 10.219744 25.7876765 10.946368 25.9694916 11.9602841L26.0763097 12.5559692 26.0617858 22.9064645l-3.1196342-1.4070082V10.4227424z" id="Path-114-Copy-2" fill="url(#linearGradient-wxw43fh1xd-5)" opacity=".69047619" mask="url(#mask-wxw43fh1xd-3)"/><polygon id="Path-41" fill="url(#linearGradient-wxw43fh1xd-6)" mask="url(#mask-wxw43fh1xd-3)" points="7.6326499 9.31647968 11.9297751 6.77228295 14.9765833 9.31647968 10.7681311 11.1500753"/><path d="M6.16852974 12.7326226C8.05429918 13.6181711 7.86496926 14.83948 8.18831704 15.006813 8.70089861 15.2720748 9.14143095 17.098905 9.86115602 17.1695013 10.6949216 17.2512836 11.6478081 10.8552079 10.3936906 10.4556578 9.48069361 10.1647855 7.32719679 9.49121213 3.93320016 8.43493769c-.63204609 1.86851711.11306377 3.30107871 2.23532958 4.29768491z" fill="url(#linearGradient-wxw43fh1xd-7)" mask="url(#mask-wxw43fh1xd-3)" transform="translate(7.357416, 12.802608) rotate(-347.000000) translate(-7.357416, -12.802608)"/><polygon id="Path-43" fill="url(#linearGradient-wxw43fh1xd-8)" mask="url(#mask-wxw43fh1xd-3)" points="12.0699788 18.5615749 6.27140769 15.1359473 5.30588708 19.0963147 12.0699788 22.1120507"/></g></g></g></g></svg></span><span class=navbar-brand__name>Koupleless</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/home/><span>首页</span></a></li><li class=nav-item><a class="nav-link active" href=/docs/><span>产品文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><span>最新信息</span></a></li><li class=nav-item><a class=nav-link href=/community/><span>参与社区</span></a></li><li class=nav-item><a class=nav-link href=/user-cases/><span>用户案例</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><ul class=dropdown-menu><li><a class=dropdown-item href=/no/></a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder=站内搜索… aria-label=站内搜索… autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/tutorials/module-development/>返回本页常规视图</a>.</p></div><h1 class=title>模块研发</h1><div class=lead>Koupleless 模块研发</div><ul><li>1: <a href=#pg-bf65e93b734e75f456eb02447ae9f065>编码规范</a></li><li>2: <a href=#pg-6e3cbd7799f1397ab7793638f56a6f1a>模块瘦身</a></li><li>3: <a href=#pg-66b2590d54145be7fd0f895684bc34ef>模块与模块、模块与基座通信</a></li><li>4: <a href=#pg-e829d04a9debc230b4d695f03971b67b>模块本地开发</a></li><li>5: <a href=#pg-28a800d400556ead949da2297e04f900>模块测试</a></li><li>6: <a href=#pg-037484c6b7708a4128ecdd19d8578aaa>复用基座拦截器</a></li><li>7: <a href=#pg-06ace3863ce3b10117de52a241f0d9e0>复用基座数据源</a></li><li>8: <a href=#pg-4a763f2560193bc6f6a4c64874383f22>静态合并部署</a></li><li>9: <a href=#pg-dbe415e386e1bcdf1f3e7a62a91e6eb6>模块中官方支持的中间件客户端</a></li><li>10: <a href=#pg-4c134980130d1dc3c830b9224a754361>SOFAArk 关键用户文档</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-bf65e93b734e75f456eb02447ae9f065>1 - 编码规范</h1><div class=lead>Koupleless 编码规范</div><h2 id=基础规范>基础规范</h2><ol><li>Koupleless 模块中官方验证并兼容的中间件客户端列表<a href=/docs/tutorials/module-development/runtime-compatibility-list>详见此处</a>。基座中可以使用任意中间件客户端。</li><li>如果使用了模块热卸载能力，模块自定义的 Timer、ThreadPool 等需要在模块<strong>卸载时手动清理</strong>。您可以监听 Spring 的 <strong>ContextClosedEvent</strong> 事件，在事件处理函数中清理必要资源，也可以在 Spring XML 定义 Timer、ThreadPool 的地方指定它们的 <strong>destroy-method，<strong>在模块卸载时，Spring 会自动执行</strong> destroy-method</strong>。</li><li>基座启动时会部署所有模块，所以基座编码时，一定要向所有模块兼容，否则基座会发布失败。如果遇到无法绕过的不兼容变更（一般是在模块拆分过程中会有比较多的基座与模块不兼容变更），请参见<a href=/docs/tutorials/module-operation/incompatible-base-and-module-upgrade>基座与模块不兼容发布</a>。</li></ol><h2 id=知识点>知识点</h2><p><a href=../module-slimming>模块瘦身</a> (重要)<br><a href=https://www.sofastack.tech/projects/sofa-boot/sofa-ark-ark-jvm/>模块与模块、模块与基座通信</a> (重要)<br><a href=../module-debug>模块测试</a> (重要)<br><a href=../reuse-base-interceptor>模块复用基座拦截器</a><br><a href=../reuse-base-datasource>模块复用基座数据源</a><br><a href=/docs/introduction/architecture/class-delegation-principle>基座与模块间类委托加载原理介绍</a></p><br><br></div><div class=td-content style=page-break-before:always><h1 id=pg-6e3cbd7799f1397ab7793638f56a6f1a>2 - 模块瘦身</h1><div class=lead>Koupleless 模块瘦身</div><h2 id=为什么要瘦身>为什么要瘦身</h2><p>为了让模块安装更快、内存消耗更小：</p><ul><li>提高模块安装的速度，减少模块包大小，减少启动依赖，控制模块安装耗时 &lt; 30秒，甚至 &lt; 5秒。</li><li>模块启动后 Spring 上下文中会创建很多对象，如果启用了模块热卸载，可能无法完全回收，安装次数过多会造成 Old 区、Metaspace 区开销大，触发频繁 FullGC，所有要控制单模块包大小 &lt; 5MB。<strong>这样不替换或重启基座也能热部署热卸载数百次。</strong></li></ul><h2 id=一键自动瘦身>一键自动瘦身</h2><h3 id=瘦身原则>瘦身原则</h3><p>构建 ark-biz jar 包的原则是，在保证模块功能的前提下，将框架、中间件等通用的包尽量放置到基座中，模块中复用基座的包，这样打出的 ark-biz jar 会更加轻量。在复杂应用中，为了更好的使用模块自动瘦身功能，需要在模块瘦身配置 (模块根目录/conf/ark/文件名.txt) 中，在样例给出的配置名单的基础上，按照既定格式，排除更多的通用依赖包。</p><h3 id=步骤一>步骤一</h3><p>在「模块项目根目录/conf/ark/文件名.txt」中（比如：my-module/conf/ark/rules.txt），按照如下格式配置需要下沉到基座的框架和中间件常用包。您也可以直接复制<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/slimming/log4j2/biz1/conf/ark/rules.txt>默认的 rules.txt 文件内容</a>到您的项目中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>excludeGroupIds=org.apache*
</span></span><span style=display:flex><span>excludeArtifactIds=commons-lang
</span></span></code></pre></div><h3 id=步骤二>步骤二</h3><p>在模块打包插件中，引入上述配置文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>&lt;!-- 插件1：打包插件为 sofa-ark biz 打包插件，打包成 ark biz jar --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>com.alipay.sofa<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>sofa-ark-maven-plugin<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>${sofa.ark.version}<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>default-cli<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;goal&gt;</span>repackage<span style=color:#204a87;font-weight:700>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;skipArkExecutable&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/skipArkExecutable&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;outputDirectory&gt;</span>./target<span style=color:#204a87;font-weight:700>&lt;/outputDirectory&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;bizName&gt;</span>biz1<span style=color:#204a87;font-weight:700>&lt;/bizName&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>&lt;!-- packExcludesConfig	模块瘦身配置，文件名自定义，和配置对应即可--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>&lt;!--					配置文件位置：biz1/conf/ark/rules.txt--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;packExcludesConfig&gt;</span>rules.txt<span style=color:#204a87;font-weight:700>&lt;/packExcludesConfig&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;webContextPath&gt;</span>biz1<span style=color:#204a87;font-weight:700>&lt;/webContextPath&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;declaredMode&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/declaredMode&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>&lt;!--					打包、安装和发布 ark biz--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>&lt;!--					静态合并部署需要配置--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>&lt;!--					&lt;attach&gt;true&lt;/attach&gt;--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
</span></span></code></pre></div><h3 id=步骤三>步骤三</h3><p>打包构建出模块 ark-biz jar 包即可，您可以明显看出瘦身后的 ark-biz jar 包大小差异。</p><p>您可<a href=https://github.com/koupleless/koupleless/tree/master/samples/springboot-samples/slimming>点击此处</a>查看完整模块瘦身样例工程。您也可以阅读下文继续了解模块的瘦身原理。</p><h2 id=基本原理>基本原理</h2><p>Koupleless 底层借助 SOFAArk 框架，实现了模块之间、模块和基座之间的相互隔离，以下两个核心逻辑对编码非常重要，需要深刻理解：</p><ol><li>基座有独立的类加载器和 Spring 上下文，模块也有<strong>独立的类加载器</strong>和** Spring 上下文**，相互之间 Spring 上下文都是<strong>隔离的</strong>。</li><li>模块启动时会初始化各种对象，会<strong>优先使用模块的类加载器</strong>去加载构建产物 FatJar 中的 class、resource 和 Jar 包，<strong>找不到的类会委托基座的类加载器</strong>去查找。</li></ol><p><img src=https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/8276/1678275655551-75bf283f-3817-447a-84b2-7f6f7f773300.jpeg alt></p><p>基于这套类委托的加载机制，让基座和模块共用的 class、resource 和 Jar 包<strong>通通下沉</strong>到基座中，可以让模块构建产物<strong>非常小</strong>，更重要的是还能让模块在运行中大量复用基座已有的 class、bean、service、IO 连接池、线程池等资源，从而模块消耗的内存<strong>非常少</strong>，启动也能<strong>非常快</strong>。<br>所谓模块瘦身，就是让基座已经有的 Jar 依赖务必在模块中剔除干净，在主 pom.xml 和 bootstrap/pom.xml 将共用的 Jar 包 <strong>scope 都声明为 provided</strong>，让其不参与打包构建。</p><h2 id=手动排包瘦身>手动排包瘦身</h2><p>模块运行时装载类时，会优先从自己的依赖里找，找不到的话再委托基座的 ClassLoader 去加载。<br>所以对于基座已经存在的依赖，在模块 pom 里将其 scope 设置成 provided，避免其参与模块打包。<br><img src="https://intranetproxy.alipay.com/skylark/lark/0/2023/png/8276/1678276103445-036d226e-4f88-40bc-937d-90fd4c60b83d.png#clientId=udf1ce5b3-f5a9-4&amp;from=paste&amp;height=521&amp;id=jFiln&amp;originHeight=1042&amp;originWidth=1848&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=957278&amp;status=done&amp;style=none&amp;taskId=u254c8709-de81-4175-bcf8-f1c4a26bc49&amp;title=&amp;width=924" alt=image.png></p><p>如果要排除的依赖无法找到，可以利用 <strong>maven helper 插件</strong>找到其直接依赖。举个例子，图示中要排除的依赖为 spring-boot-autoconfigure，右边的直接依赖有 sofa-boot-alipay-runtime，ddcs-alipay-sofa-boot-starter等（只需要看 scope 为 compile 的依赖）：<br><img src="https://intranetproxy.alipay.com/skylark/lark/0/2023/png/191604/1691733668683-34a9d11f-3ca6-4b66-a4e3-22ade9413094.png#clientId=u05d65c58-49f7-4&amp;from=paste&amp;height=869&amp;id=u467da8b5&amp;originHeight=1738&amp;originWidth=2644&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=1043897&amp;status=done&amp;style=none&amp;taskId=u70530c01-d7a5-4ca9-875d-3785f59242b&amp;title=&amp;width=1322" alt=image.png><br>确定自己代码 pom.xml 中有 ddcs-alipay-sofa-boot-starter，增加 exlcusions 来排除依赖：<br><img src="https://intranetproxy.alipay.com/skylark/lark/0/2023/png/191604/1691735644585-9201c203-b749-46e9-ab96-49ecc8090098.png#clientId=uda997d0f-c9aa-4&amp;from=paste&amp;height=244&amp;id=ub08bbabe&amp;originHeight=488&amp;originWidth=1476&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=85290&amp;status=done&amp;style=none&amp;taskId=u7f72a9d1-a1cd-422e-a50a-beafc4a9c4a&amp;title=&amp;width=738" alt=image.png></p><h2 id=在-pom-中统一排包更彻底>在 pom 中统一排包（更彻底）</h2><p>有些依赖引入了过多的间接依赖，手动排查比较困难，此时可以通过通配符匹配，把那些中间件、基座的依赖全部剔除掉，如 org.apache.commons、org.springframework 等等，这种方式会把间接依赖都排除掉，相比使用 sofa-ark-maven-plugin 排包效率会更高：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>com.koupleless.mymodule<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>mymodule-core<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;exclusions&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;exclusion&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.springframework<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>*<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;exclusion&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.apache.commons<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>*<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;exclusion&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>......<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>*<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/exclusions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id=在-sofa-ark-maven-plugin-中指定排包>在 sofa-ark-maven-plugin 中指定排包</h2><p>通过使用 **excludeGroupIds、excludeGroupIds **能够排除大量基座上已有的公共依赖：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span> <span style=color:#204a87;font-weight:700>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>com.alipay.sofa<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>sofa-ark-maven-plugin<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>default-cli<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&lt;goal&gt;</span>repackage<span style=color:#204a87;font-weight:700>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;excludeGroupIds&gt;</span>io.netty,org.apache.commons,......<span style=color:#204a87;font-weight:700>&lt;/excludeGroupIds&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;excludeArtifactIds&gt;</span>validation-api,fastjson,hessian,slf4j-api,junit,velocity,......<span style=color:#204a87;font-weight:700>&lt;/excludeArtifactIds&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;outputDirectory&gt;</span>../../target<span style=color:#204a87;font-weight:700>&lt;/outputDirectory&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;bizName&gt;</span>mymodule<span style=color:#204a87;font-weight:700>&lt;/bizName&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;finalName&gt;</span>mymodule-${project.version}-${timestamp}<span style=color:#204a87;font-weight:700>&lt;/finalName&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;bizVersion&gt;</span>${project.version}-${timestamp}<span style=color:#204a87;font-weight:700>&lt;/bizVersion&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;webContextPath&gt;</span>/mymodule<span style=color:#204a87;font-weight:700>&lt;/webContextPath&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
</span></span></code></pre></div><br><br></div><div class=td-content style=page-break-before:always><h1 id=pg-66b2590d54145be7fd0f895684bc34ef>3 - 模块与模块、模块与基座通信</h1><div class=lead>Koupleless 模块与模块、模块与基座通信</div><p>基座与模块之间、模块与模块之间存在 spring 上下文隔离，互相的 bean 不会冲突、不可见。然而很多应用场景比如中台模式、独立模块模式等存在基座调用模块、模块调用基座、模块与模块互相调用的场景。
当前支持3种方式调用，@AutowiredFromBiz, @AutowiredFromBase, SpringServiceFinder 方法调用，注意三个方式使用的情况不同。</p><h1 id=spring-环境>Spring 环境</h1><h2 id=模块里引入依赖>模块里引入依赖</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>com.alipay.koupleless<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>koupleless-app-starter<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>0.5.6<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;scope&gt;</span>provided<span style=color:#204a87;font-weight:700>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id=基座调用模块>基座调用模块</h2><p>只能使用 SpringServiceFinder</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SampleController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>Provider</span> <span style=color:#000>studentProvider</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SpringServiceFinder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModuleService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;biz&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;0.0.1-SNAPSHOT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;studentProvider&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Provider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Result</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>studentProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>provide</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Param</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>Provider</span> <span style=color:#000>teacherProvider</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SpringServiceFinder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModuleService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;biz&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;0.0.1-SNAPSHOT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;teacherProvider&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Provider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Result</span> <span style=color:#000>result1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>teacherProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>provide</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Param</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Provider</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>providerMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SpringServiceFinder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>listModuleServices</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;biz&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;0.0.1-SNAPSHOT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#000>Provider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>providerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Result</span> <span style=color:#000>result2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>providerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>provide</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Param</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;hello to ark master biz&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=模块调用基座>模块调用基座</h2><h3 id=方式一注解-autowiredfrombase>方式一：注解 @AutowiredFromBase</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SampleController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@AutowiredFromBase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;sampleServiceImplNew&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SampleService</span> <span style=color:#000>sampleServiceImplNew</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@AutowiredFromBase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;sampleServiceImpl&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SampleService</span> <span style=color:#000>sampleServiceImpl</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@AutowiredFromBase</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SampleService</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sampleServiceList</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@AutowiredFromBase</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SampleService</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sampleServiceMap</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@AutowiredFromBase</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>AppService</span> <span style=color:#000>appService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>sampleServiceImplNew</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>sampleServiceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SampleService</span> <span style=color:#000>sampleService</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sampleServiceList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>sampleService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sampleServiceMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>sampleServiceMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>appService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAppName</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;hello to ark2 dynamic deploy&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=方式二编程api-springservicefinder>方式二：编程API SpringServiceFinder</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SampleController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>SampleService</span> <span style=color:#000>sampleServiceImplFromFinder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SpringServiceFinder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBaseService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sampleServiceImpl&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SampleService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sampleServiceImplFromFinder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SampleService</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sampleServiceMapFromFinder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SpringServiceFinder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>listBaseServices</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SampleService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sampleServiceMapFromFinder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>result1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sampleServiceMapFromFinder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result1</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;hello to ark2 dynamic deploy&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=模块调用模块>模块调用模块</h2><p>参考模块调用基座，注解使用 @AutowiredFromBiz 和 编程API支持 SpringServiceFinder。</p><h3 id=方式一注解-autowiredfrombiz>方式一：注解 @AutowiredFromBiz</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SampleController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@AutowiredFromBiz</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bizName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;biz&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bizVersion</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;0.0.1-SNAPSHOT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;studentProvider&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Provider</span> <span style=color:#000>studentProvider</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@AutowiredFromBiz</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bizName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;biz&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;teacherProvider&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Provider</span> <span style=color:#000>teacherProvider</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@AutowiredFromBiz</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bizName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;biz&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bizVersion</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;0.0.1-SNAPSHOT&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Provider</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>Result</span> <span style=color:#000>provide</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>studentProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>provide</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Param</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>Result</span> <span style=color:#000>provide1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>teacherProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>provide</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Param</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Provider</span> <span style=color:#000>provider</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Result</span> <span style=color:#000>provide2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>provider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>provide</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Param</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;hello to ark2 dynamic deploy&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=方式二编程api-springservicefinder-1>方式二：编程API SpringServiceFinder</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SampleController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>Provider</span> <span style=color:#000>teacherProvider1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SpringServiceFinder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModuleService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;biz&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;0.0.1-SNAPSHOT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;teacherProvider&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Provider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Result</span> <span style=color:#000>result1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>teacherProvider1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>provide</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Param</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Provider</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>providerMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SpringServiceFinder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>listModuleServices</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;biz&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;0.0.1-SNAPSHOT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Provider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>providerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Result</span> <span style=color:#000>result2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>providerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>provide</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Param</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;hello to ark2 dynamic deploy&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><a href=https://github.com/koupleless/koupleless/tree/master/samples>完整样例</a></p><h1 id=sofaboot-环境>SOFABoot 环境</h1><p><a href=https://www.sofastack.tech/projects/sofa-boot/sofa-ark-ark-jvm/>请参考该文档</a></p><br><br></div><div class=td-content style=page-break-before:always><h1 id=pg-e829d04a9debc230b4d695f03971b67b>4 - 模块本地开发</h1><div class=lead>Koupleless 模块本地开发</div><h2 id=arkctl-工具安装>Arkctl 工具安装</h2><p>Arkctl 模块安装主要提供自动打包和部署能力，自动打包调用 mvn 命令构建模块 jar包，自动部署调用 <a href=/docs/contribution-guidelines/arklet/architecture/>arklet</a> 提供的 api 接口进行部署。如果不想使用命令行工具，也可以直接使用 arklet 提供的 api 接口发起部署操作。</p><p>方法一：</p><ol><li>本地安装 go 环境，go 依赖版本在 1.21 以上。</li><li>执行 go install <code>todo 独立的 arkctl go 仓库</code> 命令，安装 arkctl 工具。</li></ol><p>方法二：</p><ol><li>在 <a href=https://github.com/koupleless/koupleless/releases/tag/arkctl-release-0.1.0>二进制列表</a> 中下载对应的二进制并加入到本地
path 中。</li></ol><h3 id=本地快速部署>本地快速部署</h3><p>你可以使用 arkctl 工具快速地进行模块的构建和部署，提高本地调试和研发效率。</p><h4 id=场景-1模块-jar-包构建--部署到本地运行的基座中>场景 1：模块 jar 包构建 + 部署到本地运行的基座中。</h4><p>准备：</p><ol><li>在本地启动一个基座。</li><li>打开一个模块项目仓库。</li></ol><p>执行命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 需要在仓库的根目录下执行。</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 比如，如果是 maven 项目，需要在根 pom.xml 所在的目录下执行。</span>
</span></span><span style=display:flex><span>arkctl deploy
</span></span></code></pre></div><p>命令执行完成后即部署成功，用户可以进行相关的模块功能调试验证。</p><h4 id=场景-2部署一个本地构建好的-jar-包到本地运行的基座中>场景 2：部署一个本地构建好的 jar 包到本地运行的基座中。</h4><p>准备：</p><ol><li>在本地启动一个基座。</li><li>准备一个构建好的 jar 包。</li></ol><p>执行命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>arkctl deploy /path/to/your/pre/built/bundle-biz.jar
</span></span></code></pre></div><p>命令执行完成后即部署成功，用户可以进行相关的模块功能调试验证。</p><h4 id=场景-3-模块-jar-包构建--部署到远程运行的-k8s-基座中>场景 3: 模块 jar 包构建 + 部署到远程运行的 k8s 基座中。</h4><p>准备:</p><ol><li>在远程已经运行起来的基座 pod。</li><li>打开一个模块项目仓库。</li><li>本地需要有具备 exec 权限的 k8s 证书以及 kubectl 命令行工具。</li></ol><p>执行命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 需要在仓库的根目录下执行。</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 比如，如果是 maven 项目，需要在根 pom.xml 所在的目录下执行。</span>
</span></span><span style=display:flex><span>arkctl deploy --pod <span style=color:#ce5c00;font-weight:700>{</span>namespace<span style=color:#ce5c00;font-weight:700>}</span>/<span style=color:#ce5c00;font-weight:700>{</span>podName<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>命令执行完成后即部署成功，用户可以进行相关的模块功能调试验证。</p><h4 id=场景-4-在多模块的-maven-项目中在-root-构建并部署子模块的-jar-包>场景 4: 在多模块的 Maven 项目中，在 Root 构建并部署子模块的 jar 包。</h4><p>准备：</p><ol><li>在本地启动一个基座。</li><li>打开一个多模块 Maven 项目仓库。</li></ol><p>执行命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 需要在仓库的根目录下执行。</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 比如，如果是 maven 项目，需要在根 pom.xml 所在的目录下执行。</span>
</span></span><span style=display:flex><span>arkctl deploy --sub ./path/to/your/sub/module
</span></span></code></pre></div><p>命令执行完成后即部署成功，用户可以进行相关的模块功能调试验证。</p><h4 id=场景-5-查询当前基座中已经部署的模块>场景 5: 查询当前基座中已经部署的模块。</h4><p>准备：</p><ol><li>在本地启动一个基座。</li></ol><p>执行命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>arkctl status
</span></span></code></pre></div><h4 id=场景-6-查询远程-k8s-环境基座中已经部署的模块>场景 6: 查询远程 k8s 环境基座中已经部署的模块。</h4><p>准备：</p><ol><li>在远程 k8s 环境启动一个基座。</li><li>确保本地有 kube 证书以及有关权限。</li></ol><p>执行命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>arkctl status --pod <span style=color:#ce5c00;font-weight:700>{</span>namespace<span style=color:#ce5c00;font-weight:700>}</span>/<span style=color:#ce5c00;font-weight:700>{</span>name<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-28a800d400556ead949da2297e04f900>5 - 模块测试</h1><div class=lead>Koupleless 模块测试</div><h2 id=本地调试>本地调试</h2><p>您可以在本地或远程先启动基座，然后使用客户端 Arklet 暴露的 HTTP 接口在本地或远程部署模块，并且可以给模块代码打断点实现模块的本地或远程 Debug。<br>Arklet HTTP 接口主要提供了以下能力：</p><ol><li>部署和卸载模块。</li><li>查询所有已部署的模块信息。</li><li>查询各项系统和业务指标。</li></ol><h3 id=部署模块>部署模块</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X POST -H <span style=color:#4e9a06>&#34;Content-Type: application/json&#34;</span> http://127.0.0.1:1238/installBiz 
</span></span></code></pre></div><p>请求体样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;bizName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;test&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;bizVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;1.0.0&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// local path should start with file://, alse support remote url which can be downloaded
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>&#34;bizUrl&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;file:///Users/jaimezhang/workspace/github/sofa-ark-dynamic-guides/dynamic-provider/target/dynamic-provider-1.0.0-ark-biz.jar&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>部署成功返回结果样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;code&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SUCCESS&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;data&#34;</span><span style=color:#000;font-weight:700>:{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;bizInfos&#34;</span><span style=color:#000;font-weight:700>:[</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&#34;bizName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;dynamic-provider&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&#34;bizState&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;ACTIVATED&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&#34;bizVersion&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;1.0.0&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&#34;declaredMode&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&#34;identity&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;dynamic-provider:1.0.0&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&#34;mainClass&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;io.sofastack.dynamic.provider.ProviderApplication&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&#34;priority&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&#34;webContextPath&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;provider&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;code&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SUCCESS&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;Install Biz: dynamic-provider:1.0.0 success, cost: 1092 ms, started at: 16:07:47,769&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>部署失败返回结果样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;code&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;FAILED&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;data&#34;</span><span style=color:#000;font-weight:700>:{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;code&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;REPEAT_BIZ&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;Biz: dynamic-provider:1.0.0 has been installed or registered.&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=卸载模块>卸载模块</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X POST -H <span style=color:#4e9a06>&#34;Content-Type: application/json&#34;</span> http://127.0.0.1:1238/uninstallBiz 
</span></span></code></pre></div><p>请求体样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;bizName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;dynamic-provider&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;bizVersion&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;1.0.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>卸载成功返回结果样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;code&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SUCCESS&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>卸载失败返回结果样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;code&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;FAILED&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;data&#34;</span><span style=color:#000;font-weight:700>:{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;code&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;NOT_FOUND_BIZ&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;Uninstall biz: test:1.0.0 not found.&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=查询模块>查询模块</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X POST -H <span style=color:#4e9a06>&#34;Content-Type: application/json&#34;</span> http://127.0.0.1:1238/queryAllBiz 
</span></span></code></pre></div><p>请求体样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{}</span>
</span></span></code></pre></div><p>返回结果样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;code&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SUCCESS&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;data&#34;</span><span style=color:#000;font-weight:700>:[</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;bizName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;dynamic-provider&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;bizState&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;ACTIVATED&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;bizVersion&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;1.0.0&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;mainClass&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;io.sofastack.dynamic.provider.ProviderApplication&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;webContextPath&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;provider&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;bizName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;stock-mng&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;bizState&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;ACTIVATED&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;bizVersion&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;1.0.0&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;mainClass&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;embed main&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;webContextPath&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;/&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=获取帮助>获取帮助</h3><p>Arklet 暴露的所有对外 HTTP 接口，可以查看 Arklet 接口帮助：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X POST -H <span style=color:#4e9a06>&#34;Content-Type: application/json&#34;</span> http://127.0.0.1:1238/help 
</span></span></code></pre></div><p>请求体样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{}</span>
</span></span></code></pre></div><p>返回结果样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;code&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SUCCESS&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;data&#34;</span><span style=color:#000;font-weight:700>:[</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;desc&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;query all ark biz(including master biz)&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;queryAllBiz&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;desc&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;list all supported commands&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;help&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;desc&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;uninstall one ark biz&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;uninstallBiz&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;desc&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;switch one ark biz&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;switchBiz&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;desc&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;install one ark biz&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;installBiz&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=本地构建如何不改变模块版本号>本地构建如何不改变模块版本号</h2><p>添加以下 maven profile，本地构建模块使用命令 mvn clean package -Plocal</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;profile&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>local<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;build&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;plugins&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>com.alipay.sofa<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>sofa-ark-maven-plugin<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;finalName&gt;</span>${project.artifactId}-${project.version}<span style=color:#204a87;font-weight:700>&lt;/finalName&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;bizVersion&gt;</span>${project.version}<span style=color:#204a87;font-weight:700>&lt;/bizVersion&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/plugins&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/build&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/profile&gt;</span>
</span></span></code></pre></div><h2 id=单元测试>单元测试</h2><p>模块里支持使用标准 JUnit4 和 TestNG 编写和执行单元测试。</p><br><br></div><div class=td-content style=page-break-before:always><h1 id=pg-037484c6b7708a4128ecdd19d8578aaa>6 - 复用基座拦截器</h1><div class=lead>Koupleless 模块复用基座拦截器</div><h1 id=诉求>诉求</h1><p>基座中会定义很多 Aspect 切面（Spring 拦截器），你可能希望复用到模块中，但是模块和基座的 Spring 上下文是隔离的，就导致 Aspect 切面不会在模块中生效。<br><br></p><h1 id=解法>解法</h1><p>为原有的切面类创建一个代理对象，让模块能调用到这个代理对象，然后模块通过 AutoConfiguration 注解初始化出这个代理对象。完整步骤和示例代码如下：</p><h3 id=步骤-1>步骤 1：</h3><p>基座代码定义一个接口，定义切面的执行方法。这个接口需要对模块可见（在模块里引用相关依赖）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>AnnotionService</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Object</span> <span style=color:#000>doAround</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProceedingJoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=步骤-2>步骤 2：</h3><p>在基座中编写切面的具体实现，这个实现类需要加上 @SofaService 注解（SOFABoot）或者 @SpringService 注解（SpringBoot，<em>建设中</em>）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Service</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@SofaService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>uniqueId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;facadeAroundHandler&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FacadeAroundHandler</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>AnnotionService</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Logger</span> <span style=color:#000>LOG</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MY_LOGGER</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>doAround</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProceedingJoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;开始执行&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;执行完成&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=步骤-3>步骤 3：</h3><p>在模块里使用 @Aspect 注解实现一个 Aspect，SOFABoot 通过 @SofaReference 注入基座上的 FacadeAroundHandler。<br><strong>注意</strong>：这里不要声明成一个 Bean，不要加 @Component 或者 @Service 注解，主需要 @Aspect 注解。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//注意，这里不必申明成一个bean，不要加@Component或者@Service
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FacadeAroundAspect</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@SofaReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>uniqueId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;facadeAroundHandler&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>AnnotionService</span> <span style=color:#000>facadeAroundHandler</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Pointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;@annotation(com.alipay.linglongmng.presentation.mvc.interceptor.FacadeAround)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>facadeAroundPointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Around</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;facadeAroundPointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>doAround</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProceedingJoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>facadeAroundHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doAround</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=步骤-4>步骤 4：</h3><p>使用 @Configuration 注解写个 Configuration 配置类，把模块需要的 aspectj 对象都声明成 Spring Bean。<br><strong>注意</strong>：这个 Configuration 类需要对模块可见，相关 Spring Jar 依赖需要以 <scope>provided</scope> 方式引进来。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MngAspectConfiguration</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FacadeAroundAspect</span> <span style=color:#000>facadeAroundAspect</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FacadeAroundAspect</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>EnvRouteAspect</span> <span style=color:#000>envRouteAspect</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EnvRouteAspect</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FacadeAroundAspect</span> <span style=color:#000>facadeAroundAspect</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FacadeAroundAspect</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=步骤-5>步骤 5：</h3><p>模块代码中显示的依赖步骤 4 创建的 Configuration 配置类 MngAspectConfiguration。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@ImportResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath*:META-INF/spring/*.xml&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@ImportAutoConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>MngAspectConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ModuleBootstrapApplication</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>SpringApplicationBuilder</span> <span style=color:#000>builder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SpringApplicationBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ModuleBootstrapApplication</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>web</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WebApplicationType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NONE</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><br><br></div><div class=td-content style=page-break-before:always><h1 id=pg-06ace3863ce3b10117de52a241f0d9e0>7 - 复用基座数据源</h1><div class=lead>Koupleless 模块复用基座数据源</div><h2 id=建议>建议</h2><p>强烈建议使用本文档方式，在模块中尽可能<strong>复用基座数据源</strong>，否则模块反复部署就会反复创建、消耗数据源连接，导致模块发布运维会变慢，同时也会额外消耗内存。<br></p><h2 id=springboot-解法>SpringBoot 解法</h2><p>在模块的代码中写个 MybatisConfig 类即可，这样事务模板都是复用基座的，只有 Mybatis 的 SqlSessionFactoryBean 需要新创建。<br>参考 demo：/koupleless/samples/springboot-samples/db/mybatis/biz1</p><p>通过<code>SpringBeanFinder.getBaseBean</code>获取到基座的 Bean 对象，然后注册成模块的 Bean：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@MapperScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.alipay.sofa.biz1.mapper&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSessionFactoryRef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;mysqlSqlFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@EnableTransactionManagement</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MybatisConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//tips:不要初始化一个基座的DataSource，当模块被卸载的是，基座数据源会被销毁，transactionManager，transactionTemplate，mysqlSqlFactory被销毁没有问题
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;transactionManager&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PlatformTransactionManager</span> <span style=color:#000>platformTransactionManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PlatformTransactionManager</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getBaseBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transactionManager&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;transactionTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TransactionTemplate</span> <span style=color:#000>transactionTemplate</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionTemplate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getBaseBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transactionTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;mysqlSqlFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactoryBean</span> <span style=color:#000>mysqlSqlFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//数据源不能申明成模块spring上下文中的bean，因为模块卸载时会触发close方法
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getBaseBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dataSource&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>SqlSessionFactoryBean</span> <span style=color:#000>mysqlSqlFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBean</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>mysqlSqlFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>mysqlSqlFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMapperLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PathMatchingResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:mappers/*.xml&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mysqlSqlFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=sofaboot-解法>SOFABoot 解法</h2><p>如果 SOFABoot 基座没有开启多 bundle（Package 里没有 MANIFEST.MF 文件），则解法和上文 SpringBoot 完全一致。<br>如果有 MANIFEST.MF 文件，需要调用<code>BaseAppUtils.getBeanOfBundle</code>获取基座的 Bean，其中<strong>BASE_DAL_BUNDLE_NAME</strong> 为 MANIFEST.MF 里面的<code>Module-Name</code>：<br><img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/38696/1661758587977-7a499d0d-d5ca-4a68-9925-fa7258679d9b.png#clientId=ue6b6f4dc-5527-4&amp;errorMessage=unknown%20error&amp;from=paste&amp;height=458&amp;id=u531b3c3e&amp;originHeight=916&amp;originWidth=2042&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=383535&amp;status=error&amp;style=none&amp;taskId=ua403e261-49af-4d10-99e6-12edf669677&amp;title=&amp;width=1021" alt=image.png></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@MapperScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.alipay.koupleless.dal.dao&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSessionFactoryRef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;mysqlSqlFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@EnableTransactionManagement</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MybatisConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 注意：不要初始化一个基座的 DataSource，会导致模块被热卸载的时候，基座的数据源被销毁，不符合预期。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 但是 transactionManager，transactionTemplate，mysqlSqlFactory 这些资源被销毁没有问题
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>BASE_DAL_BUNDLE_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.alipay.koupleless.dal&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;transactionManager&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PlatformTransactionManager</span> <span style=color:#000>platformTransactionManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PlatformTransactionManager</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>BaseAppUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanOfBundle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transactionManager&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>BASE_DAL_BUNDLE_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;transactionTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TransactionTemplate</span> <span style=color:#000>transactionTemplate</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionTemplate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>BaseAppUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanOfBundle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transactionTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>BASE_DAL_BUNDLE_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;mysqlSqlFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactoryBean</span> <span style=color:#000>mysqlSqlFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//数据源不能申明成模块spring上下文中的bean，因为模块卸载时会触发close方法
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ZdalDataSource</span> <span style=color:#000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ZdalDataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>BaseAppUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanOfBundle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dataSource&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>BASE_DAL_BUNDLE_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>SqlSessionFactoryBean</span> <span style=color:#000>mysqlSqlFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBean</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>mysqlSqlFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>mysqlSqlFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMapperLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PathMatchingResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:mapper/*.xml&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mysqlSqlFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><br><br></div><div class=td-content style=page-break-before:always><h1 id=pg-4a763f2560193bc6f6a4c64874383f22>8 - 静态合并部署</h1><div class=lead>Koupleless 模块静态合并部署</div><h2 id=介绍>介绍</h2><p>SOFAArk 提供了静态合并部署能力，在开发阶段，应用可以将其他应用构建成的 <strong>Biz 包（模块应用)</strong>，并被最终的 <strong>Base 包（基座应用）</strong> 加载。
用户可以把 Biz 包统一放置在某个目录中，然后通过启动参数告知基座扫描这个目录，以此完成静态合并部署（详情见下描述）。如此，开发不需要考虑相互之间依赖冲突问题，Biz 之间则通过 @SofaService 和 @SofaReference 发布/引用 JVM 服务（<em>SOFABoot，SpringBoot 还在建设中</em>
）进行交互。</p><h2 id=步骤-1模块应用打包成-ark-biz>步骤 1：模块应用打包成 Ark Biz</h2><p>如果开发者希望自己应用的 Ark Biz 包能够被其他应用直接当成 Jar 包依赖，进而运行在同一个 SOFAArk 容器之上，那么就需要打包发布 Ark Biz
包，详见 <a href=https://www.sofastack.tech/projects/sofa-boot/sofa-ark-ark-biz/>Ark Biz 介绍</a>。 Ark Biz 包使用
Maven 插件 sofa-ark-maven-plugin 打包生成。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;build&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>com.alipay.sofa<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>sofa-ark-maven-plugin<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>${sofa.ark.version}<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>default-cli<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;goal&gt;</span>repackage<span style=color:#204a87;font-weight:700>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/build&gt;</span>
</span></span></code></pre></div><h2 id=步骤-2将上述-jar-包移动到指定目录>步骤 2：将上述 jar 包移动到指定目录。</h2><p>把需要部署的 biz jar 都移动到指定目录，如：/home/sofa-ark/biz/</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mv /path/to/your/biz/jar /home/sofa-ark/biz/
</span></span></code></pre></div><h2 id=步骤-3启动基座并通过--d-参指定-biz-目录>步骤 3：启动基座，并通过 -D 参指定 biz 目录</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>java -jar -Dcom.alipay.sofa.ark.static.biz.dir<span style=color:#ce5c00;font-weight:700>=</span>/home/sofa-ark/biz/ sofa-ark-base.jar
</span></span></code></pre></div><h2 id=步骤-4验证-ark-biz模块启动>步骤 4：验证 Ark Biz（模块）启动</h2><p>在基座启动成功后，可以通过 telnet 启动 SOFAArk 客户端交互界面：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>telnet localhost <span style=color:#0000cf;font-weight:700>1234</span>
</span></span></code></pre></div><p>然后执行如下命令查看模块列表：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>biz -a
</span></span></code></pre></div><p>此时应当可以看到 Master Biz（基座）和所有静态合并部署的 Ark Biz（模块）。<br>上述操作可以通过 <a href=https://github.com/koupleless/koupleless/blob/master/samples/springboot-samples/web/tomcat/README.md#%E5%AE%9E%E9%AA%8C%E5%86%85%E5%AE%B9(%E9%9D%99%E6%80%81%E5%90%88%E5%B9%B6%E9%83%A8%E7%BD%B2)>SOFAArk 静态合并部署样例</a>
体验。<br></p><br><br></div><div class=td-content style=page-break-before:always><h1 id=pg-dbe415e386e1bcdf1f3e7a62a91e6eb6>9 - 模块中官方支持的中间件客户端</h1><div class=lead>Koupleless 模块中官方支持的中间件客户端</div><p>在 Koupleless 模块中，官方目前支持并兼容常见的中间件客户端。<br><strong>注意</strong>，这里 “<strong>已经支持</strong>” 需要在基座 POM
中引入相关客户端依赖（<strong>强烈建议使用 SpringBoot Starter 方式引入相关依赖</strong>），同时在模块 POM 中也引入相关依赖并设置 *
<em><scope>provided</scope></em>* 将依赖委托给基座加载。</p><br><table><thead><tr><th>中间件客户端</th><th>版本号</th><th>备注</th></tr></thead><tbody><tr><td>JDK</td><td>8.x<br>17.x</td><td><em><strong>已经支持</strong></em><br></td></tr><tr><td>SpringBoot</td><td>>= 2.3.0 或 3.x</td><td><em><strong>已经支持</strong></em><br>JDK17 + SpringBoot3.x 基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/tree/main/samples/springboot3-samples/web/tomcat>参见此处</a></td></tr><tr><td>SpringBoot Cloud</td><td>>= 2.7.x</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/tree/main/samples/springboot-samples/springcloud/>参见此处</a></td></tr><tr><td>SOFABoot</td><td>>= 3.9.0 或 4.x</td><td><em><strong>已经支持</strong></em><br></td></tr><tr><td>JMX</td><td>N/A</td><td><em><strong>已经支持</strong></em><br>需要给基座加 <em>-Dspring.jmx.default-domain=${spring.application.name}</em> 启动参数<br></td></tr><tr><td>log4j2</td><td>任意</td><td><em><strong>已经支持</strong></em>。在基座和模块引入 log4j2，并额外引入依赖：<br>&lt;dependency><br>  &lt;groupId>com.alipay.koupleless&lt;/groupId><br>  &lt;artifactId>koupleless-adapter-log4j2&lt;/artifactId><br>  &lt;version>${最新版 Koupleless 版本}&lt;/version><br>  &lt;scope>provided&lt;/scope> &lt;!&ndash; 模块需要 provided &ndash;><br>  &lt;/dependency><br>基座和模块完整使用样例<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/logging/log4j2/README.md>参见此处</a></td></tr><tr><td>slf4j-api</td><td>1.x 且 >= 1.7</td><td><em><strong>已经支持</strong></em><br></td></tr><tr><td>tomcat</td><td>7.x、8.x、9.x、10.x<br>及以上均可</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/web/tomcat>参见此处</a></td></tr><tr><td>netty</td><td>4.x</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/web/webflux>参见此处</a></td></tr><tr><td>sofarpc</td><td>>= 5.8.6</td><td><em><strong>已经支持</strong></em><br></td></tr><tr><td>dubbo</td><td>3.x</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例及注意事项可<a href=https://github.com/koupleless/koupleless/tree/main/samples/dubbo-samples/rpc>参见此处</a></td></tr><tr><td>grpc</td><td>1.x 且 >= 1.42</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例及注意事项可<a href=https://github.com/koupleless/koupleless/tree/main/samples/dubbo-samples/rpc/dubbo26>参见此处</a></td></tr><tr><td>protobuf-java</td><td>3.x 且 >= 3.17</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例及注意事项可<a href=https://github.com/koupleless/koupleless/tree/main/samples/dubbo-samples/rpc/dubbo26>参见此处</a></td></tr><tr><td>apollo</td><td>1.x 且 >= 1.6.0</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例及注意事项可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/config/apollo>参见此处</a></td></tr><tr><td>nacos</td><td>2.1.x</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例及注意事项可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/config/nacos>参见此处</a></td></tr><tr><td>kafka-client</td><td>>= 2.8.0 或<br>>= 3.4.0</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/msg/kafka>参见此处</a></td></tr><tr><td>rocketmq</td><td>4.x 且 >= 4.3.0</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/msg/rocketmq>参见此处</a></td></tr><tr><td>jedis</td><td>3.x</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/cache/redis>参见此处</a></td></tr><tr><td>xxl-job</td><td>2.x 且 >= 2.1.0</td><td><em><strong>已经支持</strong></em><br>需要在模块里声明为 compile 依赖独立使用<br></td></tr><tr><td>mybatis</td><td>>= 2.2.2 或<br>>= 3.5.12</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/db/mybatis/README.md>参见此处</a></td></tr><tr><td>druid</td><td>1.x</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/db/mybatis/README.md>参见此处</a></td></tr><tr><td>mysql-connector-java</td><td>8.x</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/db/mybatis/README.md>参见此处</a></td></tr><tr><td>postgresql</td><td>42.x 且 >= 42.3.8</td><td><em><strong>已经支持</strong></em></td></tr><tr><td>mongodb</td><td>4.6.1</td><td><em><strong>已经支持</strong></em><br>基座和模块完整使用样例可<a href=https://github.com/koupleless/koupleless/blob/main/samples/springboot-samples/db/mongo/README.md>参见此处</a></td></tr><tr><td>hibernate</td><td>5.x 且 >= 5.6.15</td><td><em><strong>已经支持</strong></em></td></tr><tr><td>j2cache</td><td>任意</td><td><em><strong>已经支持</strong></em><br>需要在模块里声明为 compile 依赖独立使用<br></td></tr><tr><td>opentracing</td><td>0.x 且 >= 0.32.0</td><td><em><strong>已经支持</strong></em></td></tr><tr><td>elasticsearch</td><td>7.x 且 >= 7.6.2</td><td><em><strong>已经支持</strong></em></td></tr><tr><td>jaspyt</td><td>1.x 且 >= 1.9.3</td><td><em><strong>已经支持</strong></em></td></tr><tr><td>OKHttp</td><td>-</td><td><em><strong>已经支持</strong></em><br>需要放在基座里，请使用<a href=https://github.com/koupleless/koupleless/blob/main/docs/content/zh-cn/docs/tutorials/module-development/module-slimming.md>模块自动瘦身能力</a></td></tr><tr><td>io.kubernetes:client</td><td>10.x 且 >= 10.0.0</td><td><em><strong>已经支持</strong></em></td></tr><tr><td>net.java.dev.jna</td><td>5.x 且 >= 5.12.1</td><td><em><strong>已经支持</strong></em></td></tr><tr><td>prometheus</td><td>-</td><td>待验证支持</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-4c134980130d1dc3c830b9224a754361>10 - SOFAArk 关键用户文档</h1><p><b><a href=https://www.sofastack.tech/projects/sofa-boot/sofa-ark-biz-lifecycle/>模块生命周期</a></b><br><br><b><a href=https://www.sofastack.tech/projects/sofa-boot/sofa-ark-ark-event/>Ark 事件机制</a></b><br><br><b><a href=https://www.sofastack.tech/projects/sofa-boot/sofa-ark-ark-log/>Ark 自身日志</a></b><br><br></p><br><br></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=通过社区交流群 aria-label=通过社区交流群><a target=_blank rel=noopener href=/docs/contribution-guidelines/communication-channel/ aria-label=通过社区交流群><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=看这里 aria-label=看这里><a target=_blank rel=noopener href=/docs/contribution-guidelines/contribution/first-pr/ aria-label=看这里><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2024 Koupleless 开源社区 保留所有权利</span></div></div></div></footer></div><script src=/js/main.min.6b611378dd7aa9db092fab7032555c3f7cf1f6f0216c4527424189c537230618.js integrity="sha256-a2ETeN16qdsJL6twMlVcP3zx9vAhbEUnQkGJxTcjBhg=" crossorigin=anonymous></script>
<script src=/js/prism.js></script>
<script src=/js/tabpane-persist.js></script></body></html>