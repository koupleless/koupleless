<div align="center">

English | [简体中文](./README-zh_CN.md)

</div>

# Experiment Content
## Experiment Application
### base
The base is built from regular SpringBoot application. The only change you need to do is to add the following dependencies in pom
```xml
<!-- Add dependencies related to the dynamic module here -->
<dependency>
    <groupId>com.alipay.sofa.koupleless</groupId>
    <artifactId>koupleless-base-starter</artifactId>
    <!-- The above version supports springboot3 -->
    <version>0.5.5-jdk17</version>
</dependency>
<!-- end dynamic module related dependencies -->
        
<!-- Add dependencies for deploying multiple web applications in single host mode of tomcat here -->
<dependency>
    <groupId>com.alipay.sofa</groupId>
    <artifactId>web-ark-plugin</artifactId>
    <!-- Exclude log-sofa-boot-starter in web-ark-plugin -->
    <exclusions>
        <exclusion>
            <groupId>com.alipay.sofa</groupId>
            <artifactId>log-sofa-boot-starter</artifactId>
        </exclusion>
    </exclusions>
</dependency>
<!-- End of dependencies for single host deployment -->

<!-- log4j2 related dependencies -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-log4j2</artifactId>
</dependency>

<!-- log4j2 asynchronous queue -->
<dependency>
    <groupId>com.lmax</groupId>
    <artifactId>disruptor</artifactId>
    <version>${disruptor.version}</version>
</dependency>
<dependency>
    <groupId>com.alipay.sofa.koupleless</groupId>
    <artifactId>koupleless-log4j2-starter</artifactId>
    <version>${koupleless.runtime.version}</version>
</dependency>
<!-- end log4j2 dependency introduction -->

<!-- add kafka dependency -->
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>
<!-- end kafka -->
```

### biz
The biz contains two modules, biz1 and biz2, both are regular SpringBoot. The packaging plugin method is modified to the sofaArk biz module packaging method, packaged as an ark biz jar package, and the packaging plugin configuration is as follows:
```xml
<!-- The module needs to introduce a special log4j2 adapter -->
<dependency>
    <groupId>com.alipay.sofa.koupleless</groupId>
    <artifactId>koupleless-adapter-log4j2</artifactId>
    <version>${koupleless.runtime.version}</version>
    <scope>provided</scope>
</dependency>
<!-- add kafka dependency -->
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
    <scope>provided</scope>
</dependency>
<!-- end kafka -->

<!-- Modify the packaging plugin to the sofa-ark biz packaging plugin, package into ark biz jar -->
<plugin>
    <groupId>com.alipay.sofa</groupId>
    <artifactId>sofa-ark-maven-plugin</artifactId>
    <version>${sofa.ark.version}</version>
    <executions>
        <execution>
            <id>default-cli</id>
            <goals>
                <goal>repackage</goal>
            </goals>
        </execution>
    </executions>
    <configuration>
        <skipArkExecutable>true</skipArkExecutable>
        <outputDirectory>./target</outputDirectory>
        <bizName>${bizName}</bizName>
        <!-- Change the web context path under a single host -->
        <webContextPath>${bizName}</webContextPath>
        <declaredMode>true</declaredMode>
    </configuration>
</plugin>
```
Note that the web context path of different biz is changed to different values, so that multiple web applications can be successfully installed in a tomcat host.

## Experiment Steps

### build and start kafka server
#### 
cd into config directory, execute the following command, if the network is not connected, you need to open the proxy
```shell
docker build .
```

If the network is still not connected, you can execute it locally according to the command in Dockerfile, or you can start the kafka server directly

### Run the image
```shell
docker run -p 2181:2181 -p 9092:9092 -e ADVERTISED_HOST=localhost serverless-registry.cn-shanghai.cr.aliyuncs.com/opensource/samples/kafka-zookeeper:0.1.1
```

#### 执行 mvn clean package -DskipTests
#### run `mvn clean package -DskipTests`
You can see the ark-biz jar package generated by the package in the target directory of each bundle
#### Start the base application, and make sure the base starts successfully
####　Execute curl command to install biz1 and biz2
```shell
curl --location --request POST 'localhost:1238/installBiz' \
--header 'Content-Type: application/json' \
--data '{
    "bizName": "biz1",
    "bizVersion": "0.0.1-SNAPSHOT",
    // local path should start with file://, alse support remote url which can be downloaded
    "bizUrl": "file:///path/to/springboot-samples/samples/web/tomcat/biz1/target/biz1-kafka-0.0.1-SNAPSHOT-ark-biz.jar"
}'
```

```shell
curl --location --request POST 'localhost:1238/installBiz' \
--header 'Content-Type: application/json' \
--data '{
    "bizName": "biz2",
    "bizVersion": "0.0.1-SNAPSHOT",
    // local path should start with file://, alse support remote url which can be downloaded
    "bizUrl": "file:///path/to/springboot-samples/samples/web/tomcat/biz2/target/biz2-kafka-0.0.1-SNAPSHOT-ark-biz.jar"
}'
```

If you want to verify the uninstallation, you can also execute
```shell
curl --location --request POST 'localhost:1238/uninstallBiz' \
--header 'Content-Type: application/json' \
--data '{
    "bizName": "biz1",
    "bizVersion": "0.0.1-SNAPSHOT"
}'
```

### Start a request to verify

```shell
curl http://localhost:8080/biz1/send/fadsfasdfa
```
return `hello to /biz1 deploy`

You can see the log
```text
INFO  rest.SampleController - =================================
INFO  rest.SampleController - biz1 consumer input value: fadsfasdfa
INFO  rest.SampleController - =================================
```

```shell
curl http://localhost:8080/biz2/send/fadsfasdfa
```
return `hello to /biz2 deploy`

You can see the log
```text
INFO  rest.SampleController - =================================
INFO  rest.SampleController - biz2 consumer input value: fadsfasdfa
INFO  rest.SampleController - =================================
```

## Precautions
Here mainly use simple applications for verification, if complex applications, need to pay attention to the module to do a good job of slimming, the base has dependencies, the module as much as possible set to provided, as much as possible to use the base dependencies.
