<div align="center">

English | [简体中文](./README-zh_CN.md)

</div>

#  log4j2 Different Applications Print to Different Directories
For the principle, see [here](https://koupleless.gitee.io/docs/contribution-guidelines/runtime/logj42/)

# Experiment Content
## Experiment Application
### base
The base is built from regular SpringBoot application. The only change you need to do is to add the following dependencies in pom
```xml


<!-- Add dynamic module related dependencies here -->
<dependency>
    <groupId>com.alipay.sofa.koupleless</groupId>
    <artifactId>koupleless-base-starter</artifactId>
    <!-- The above version supports springboot3 -->
    <version>0.5.5-jdk17</version>
</dependency>
        <!-- end dynamic module related dependencies -->

        <!-- Add dependencies for deploying multiple web applications in single host mode of tomcat here -->
<dependency>
    <groupId>com.alipay.sofa</groupId>
    <artifactId>web-ark-plugin</artifactId>
    <!-- Exclude log-sofa-boot-starter in web-ark-plugin -->
    <exclusions>
        <exclusion>
            <groupId>com.alipay.sofa</groupId>
            <artifactId>log-sofa-boot-starter</artifactId>
        </exclusion>
    </exclusions>
</dependency>
        <!-- end dependencies for single host deployment -->

        <!-- log4j2 related dependencies -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-log4j2</artifactId>
</dependency>

        <!-- log4j2 asynchronous queue -->
<dependency>
    <groupId>com.lmax</groupId>
    <artifactId>disruptor</artifactId>
    <version>${disruptor.version}</version>
</dependency>
<dependency>
    <groupId>com.alipay.sofa.koupleless</groupId>
    <artifactId>koupleless-log4j2-starter</artifactId>
    <version>${sofa.serverless.runtime.version}</version>
</dependency>
        <!-- end log4j2 dependency introduction -->
```

### biz
The biz contains two modules, biz1 and biz2, both are regular SpringBoot. The packaging plugin method is modified to the sofaArk biz module packaging method, packaged as an ark biz jar package, and the packaging plugin configuration is as follows:
```xml
<!-- The module needs to introduce a special log4j2 adapter -->
<dependency>
    <groupId>com.alipay.sofa.koupleless</groupId>
    <artifactId>koupleless-adapter-log4j2</artifactId>
    <version>${sofa.serverless.runtime.version}</version>
    <scope>provided</scope>
</dependency>

        <!-- Modify the packaging plugin to the sofa-ark biz packaging plugin, package into ark biz jar -->
<plugin>
    <groupId>com.alipay.sofa</groupId>
    <artifactId>sofa-ark-maven-plugin</artifactId>
    <version>${sofa.ark.version}</version>
    <executions>
        <execution>
            <id>default-cli</id>
            <goals>
                <goal>repackage</goal>
            </goals>
        </execution>
    </executions>
    <configuration>
        <skipArkExecutable>true</skipArkExecutable>
        <outputDirectory>./target</outputDirectory>
        <bizName>${bizName}</bizName>
        <!-- Under single host, you need to change the web context path -->
        <webContextPath>${bizName}</webContextPath>
        <declaredMode>true</declaredMode>
    </configuration>
</plugin>
```
Note that the web context path of different biz is changed to different values, so that multiple web applications can be successfully installed in a tomcat host.


## Experiment Task
### Execute `mvn clean package -DskipTests`
You can see the ark-biz jar package generated by the package in the target directory of each bundle
### Start the base application base, make sure the base starts successfully
### Execute the curl command to install biz1 and biz2
```shell
curl --location --request POST 'localhost:1238/installBiz' \
--header 'Content-Type: application/json' \
--data '{
    "bizName": "biz1",
    "bizVersion": "0.0.1-SNAPSHOT",
    // local path should start with file://, alse support remote url which can be downloaded
    "bizUrl": "file:///path/to/springboot-samples/samples/web/tomcat/biz1/target/biz1-log4j2-0.0.1-SNAPSHOT-ark-biz.jar"
}'
```

```shell
curl --location --request POST 'localhost:1238/installBiz' \
--header 'Content-Type: application/json' \
--data '{
    "bizName": "biz2",
    "bizVersion": "0.0.1-SNAPSHOT",
    // local path should start with file://, alse support remote url which can be downloaded
    "bizUrl": "file:///path/to/springboot-samples/samples/web/tomcat/biz2/target/biz2-log4j2-0.0.1-SNAPSHOT-ark-biz.jar"
}'
```

If you want to verify the uninstallation, you can also execute
```shell
curl --location --request POST 'localhost:1238/uninstallBiz' \
--header 'Content-Type: application/json' \
--data '{
    "bizName": "biz1",
    "bizVersion": "0.0.1-SNAPSHOT"
}'
```

### Start a request to verify
```shell
curl http://localhost:8080/biz1
```
Return `hello to /biz1 deploy`


```shell
curl http://localhost:8080/biz2
```
Return `hello to /biz2 deploy`

### Check if the log printing is normal
1. Check content 1, you can see the log when the module starts in the
![img.png](imgs/biz1-log.png)
![img_1.png](imgs/biz2-log.png)

2.Check content 2, the log dir structure in the `./samples/logging/log4j2/logs/` directory as the following
![img_2.png](imgs/logs-structure.png)

- The application log of biz1 is in the `./samples/logging/log4j2/logs/biz1/` directory
- The application log of biz2 is in the `./samples/logging/log4j2/logs/biz2/` directory
- The application log of base is in the `./samples/logging/log4j2/logs/base/` directory
-The framework logs of biz1, biz2, base (such as spring sofaArk arklet, etc.), are merged in the same directory file


## Precautions
Here mainly use simple applications for verification, if complex applications, need to pay attention to the module to do a good job of slimming, the base has dependencies, the module as much as possible set to provided, as much as possible to use the base dependencies.
